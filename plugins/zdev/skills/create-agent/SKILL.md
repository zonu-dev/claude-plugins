---
name: create-agent
description: エージェント定義ファイルを作成し、レビュー・自動修正まで行う
allowed-tools: Read, Write, Edit, Glob, AskUserQuestion, Skill, TaskCreate, TaskUpdate, TaskList
argument-hint: "[エージェント名] [エージェントの説明]"
disable-model-invocation: true
---

# /create-agent - エージェント作成コマンド

このコマンドは、エージェント定義ファイルを作成し、review-agentスキルでレビュー・自動修正を行います。

## 使い方

### 引数付き起動
```
/create-agent issue-analyzer GitHub Issueを分析してコードベースとの関連を調査する
```

### 引数なし起動(対話的)
```
/create-agent
```

---

## [1/4] エージェント情報の取得

### 引数の解析

引数からエージェント情報を取得します:
- `$1`: エージェント名
- `$2`以降: エージェントの説明

```
エージェント名: $1
エージェントの説明: $ARGUMENTS から $1 を除いた部分
```

$1が空の場合、AskUserQuestionツールでエージェント名を質問:
- 質問: 「作成するエージェントの名前を入力してください」
- 例として `issue-analyzer`, `test-runner`, `code-reviewer` を提示
- 選択肢: 「名前を入力」（Otherで直接入力）

エージェント名取得後、説明が空の場合もAskUserQuestionツールで質問:
- 質問: 「エージェントの説明を入力してください。何を行うエージェントですか？」
- 例として「GitHub Issueの内容を分析し、コードベースとの関連を調査する」等を提示
- 選択肢: 「説明を入力」（Otherで直接入力）

### エージェント種別とモデルの決定

デフォルト値：
- 種別: **分析・調査**（ツール: `Glob, Grep, Read`）
- モデル: **sonnet**

ユーザーの説明から種別とモデルを自動判定する。判断に迷う場合のみ AskUserQuestion で確認する。

種別の対応表：

| 種別 | ツール | 適用ケース |
|------|--------|-----------|
| 分析・調査 | `Glob, Grep, Read` | コードベースの分析・調査 |
| 実装・修正 | `Glob, Grep, Read, Edit, Write, Bash` | コードの実装・修正 |
| レビュー | `Glob, Grep, Read` | コードやドキュメントのレビュー |
| ドキュメント生成 | `Glob, Grep, Read, Edit, Write` | ドキュメントの生成・更新 |

モデルの選択基準：
- **sonnet**: 大半のタスクに適切（デフォルト）
- **haiku**: 単純な分類・抽出・定型処理向け
- **opus**: 高度な推論・複雑な判断が必要なタスク向け

---

## [2/4] エージェントの作成

### TaskCreateでタスク管理

TaskCreateツールで以下の3つのタスクを作成:
1. 「エージェント定義ファイルを作成」（activeForm: エージェントを作成している）
2. 「review-agentでエージェントをレビュー」（activeForm: エージェントをレビューしている）
3. 「レビュー結果に基づいて自動修正」（activeForm: エージェントを自動修正している）

タスク#1をin_progressに更新してから次へ進む。

### エージェント定義ファイルの生成

`agents/[エージェント名].md` を以下のテンプレートに従って生成する:

```markdown
---
name: {エージェント名}
description: {エージェントの説明（英語）}
tools: {種別に応じたツールリスト}
model: {選択されたモデル}
---

# {エージェントの日本語タイトル}

{エージェントの役割説明（日本語）}

## 入力

プロンプトとして以下の情報が渡されます：
- {入力パラメータ1}
- {入力パラメータ2}

## タスク

### 1. {ステップ1のタイトル}

{ステップ1の詳細}

### 2. {ステップ2のタイトル}

{ステップ2の詳細}

### 3. {ステップ3のタイトル}

{ステップ3の詳細}

## 出力形式

以下の形式で結果を出力してください：

\```markdown
## {出力セクション1}
- ...

## {出力セクション2}
- ...
\```

## 注意事項

- {注意事項1}
- {注意事項2}
```

**生成時の重要ルール**:
1. **descriptionは英語**で記述する（Claude Codeの仕様に合わせる）
2. **ボディ（システムプロンプト）は日本語**で記述する
3. ユーザーから取得した説明をもとに、エージェントの目的に合った具体的なワークフローを設計する
4. 入力仕様・出力形式は具体的なテンプレートで定義する
5. ツールリストは種別選択に基づいて自動設定する

### 作成完了の確認

エージェント定義ファイルが正常に作成されたことを確認:
- ファイルが `agents/` ディレクトリに生成されたか
- YAMLフロントマターが正しく記述されているか

---

## [3/4] レビューと自動修正

### TaskUpdate更新

タスク#1をcompletedに、タスク#2をin_progressに更新する。

### review-agentの実行

Skillツールを使用してreview-agentスキルを実行します:

```javascript
Skill({
  skill: "review-agent"
})
```

### レビュー結果の処理

**問題がない場合**:
1. タスク#2, #3をcompletedに更新
2. 完了サマリーを表示して終了

**問題がある場合**:
1. タスク#2をcompleted、タスク#3をin_progressに更新
2. 指摘された問題を自動的に修正
3. 再度review-agentを実行して確認
4. 問題がなくなるまで繰り返す（最大3回）

### 自動修正のルール

review-agentから指摘された問題を自動修正する際:

1. **ツールの問題**: 過剰なツールの削除、不足ツールの追加
2. **モデルの問題**: 適切なモデルへの変更
3. **構造的な問題**: セクション構成の修正、入出力仕様の追加
4. **内容の問題**: 役割定義の明確化、具体例の追加
5. **言語の問題**: システムプロンプトが英語の場合は日本語に翻訳

**修正後は必ず再レビュー**を実行して、問題が解決されたことを確認してください。

---

## [4/4] README更新

レビュー・自動修正が完了したら、プラグインの `README.md` にエージェント情報を追加する。

エージェントセクションがない場合は新規作成し、ある場合はテーブルに行を追加:

```markdown
## 提供エージェント

| エージェント | 説明 |
|-------------|------|
| `{エージェント名}` | {エージェントの説明} |
```

---

## 完了サマリー

### サマリー表示

以下の情報を表示してください:

```
✓ エージェントの作成が完了しました

エージェント名: [エージェント名]
説明: [エージェントの説明]
種別: [分析・調査 / 実装・修正 / レビュー / ドキュメント生成]
モデル: [sonnet / haiku / opus]

作成されたファイル:
- agents/[エージェント名].md

レビュー結果:
- [問題なし / N件の問題を自動修正]
```

---

## 重要な注意事項

### 自動修正の制限

- 最大3回まで自動修正を試行
- 3回試行しても問題が解決しない場合は、ユーザーに手動対応を依頼

### エラーハンドリング

- agents/ ディレクトリが存在しない場合は自動作成
- 同名のエージェントが既に存在する場合はユーザーに上書き確認
- review-agentの実行エラー時はリトライオプションを提供
