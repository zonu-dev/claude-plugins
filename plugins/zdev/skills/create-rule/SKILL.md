---
description: "Claude Codeのルールファイル（.claude/rules/）を作成し、妥当性判定・レビュー・自動修正まで一貫して行う。"
argument-hint: "[ルール名] [ルールの説明]"
disable-model-invocation: true
---

# /create-rule - ルール作成コマンド

ルール化の妥当性を事前判定し、`.claude/rules/` にルールファイルを作成する。review-rule でレビュー・自動修正を行う。

## 使い方

### 引数付き起動
```
/create-rule backend-layers バックエンドのレイヤー設計制約
```

### 引数なし起動(対話的)
```
/create-rule
```

---

## [1/5] ルール情報の取得

### 引数の解析

引数からルール情報を取得します:
- `$1`: ルール名（ケバブケース）
- `$2`以降: ルールの説明

```
ルール名: $1
ルールの説明: $ARGUMENTS から $1 を除いた部分
```

$1が空の場合、AskUserQuestion ツールでルール名を質問:
- 質問: 「作成するルールの名前を入力してください（ケバブケース）」
- 例として `api-layers`, `billing`, `srs` を提示
- 選択肢: 「名前を入力」（Other で直接入力）

ルール名取得後、説明が空の場合も AskUserQuestion ツールで質問:
- 質問: 「ルールの説明を入力してください。何を制約・規定するルールですか？」
- 例として「バックエンドのレイヤー間の依存方向と各レイヤーの責務」等を提示
- 選択肢: 「説明を入力」（Other で直接入力）

### スコープの確認

AskUserQuestion ツールでスコープを確認:
- 質問: 「このルールの適用スコープを選択してください」
- 選択肢:
  - **パス指定（推奨）**: 特定パッケージやディレクトリに関するルール。`paths` フロントマターで対象を限定する
  - **常時適用**: パッケージ間の依存方向やコーディング規約全般など、全ファイルに適用するルール。フロントマターなし

パス指定を選択した場合、対象パスも取得:
- 質問: 「対象パスのグロブパターンを入力してください（カンマ区切りで複数可）」
- 例として `packages/mobile/src/**`, `backend/api/src/**` を提示

---

## [2/5] ルール化妥当性の判定

**このステップはスキップ不可。** ルール作成前に妥当性を必ず判定する。

### コードベース調査

対象パスのコードを読み、以下を確認:
1. 既存のコードに一貫したパターンがあるか（自明性の判断）
2. 既存の `.claude/rules/` ファイルに類似ルールがないか（重複チェック）
3. `CLAUDE.md` に関連する記述がないか（矛盾チェック）
4. ESLint・dependency-cruiser 等の自動検証でカバー済みでないか

### 5基準チェック

[ルール化妥当性の5基準](references/rule-criteria.md)に従って判定し、結果テンプレートに沿ってユーザーに提示する。該当数に応じて次のアクションを決定する。

---

## [3/5] ルールファイルの作成

### TaskCreate でタスク管理

TaskCreate ツールで以下の3つのタスクを作成:
1. 「ルールファイルを作成」（activeForm: ルールを作成している）
2. 「review-rule でルールをレビュー」（activeForm: ルールをレビューしている）
3. 「レビュー結果に基づいて自動修正」（activeForm: ルールを自動修正している）

タスク#1を in_progress に更新してから次へ進む。

### ルールファイルの生成

`.claude/rules/[ルール名].md` を[ルールファイルテンプレート](references/rule-criteria.md)の構造で生成する。

### 生成時の重要ルール

1. **日本語**で記述する
2. 各指示は**具体的でアクショナブル**にする（「〜に注意する」は禁止）
3. **100行以下**に収める
4. **1ファイル1関心事**を徹底する
5. コード例の埋め込みは避け、ファイルパスで参照する
6. `CLAUDE.md` や既存ルールとの重複を避ける

### 作成完了の確認

ルールファイルが正常に作成されたことを確認:
- ファイルが `.claude/rules/` に生成されたか
- YAML フロントマターが正しく記述されているか（パス指定の場合）

---

## [4/5] レビューと自動修正

### TaskUpdate 更新

タスク#1を completed に、タスク#2を in_progress に更新する。

### review-rule の実行

Skill ツールを使用して review-rule スキルを実行します。作成したファイルパスを `args` で渡し、対象を限定します:

```javascript
Skill({
  skill: "review-rule",
  args: ".claude/rules/{ルール名}.md"
})
```

### レビュー結果の処理

**問題がない場合**:
1. タスク#2, #3を completed に更新
2. 完了サマリーを表示して終了

**問題がある場合**:
1. タスク#2を completed、タスク#3を in_progress に更新
2. 指摘された問題を自動的に修正
3. 再度 review-rule を実行して確認
4. 問題がなくなるまで繰り返す（最大3回）

### 自動修正のルール

review-rule から指摘された問題を自動修正する際:

1. **スコープの問題**: `paths` パターンの修正、常時適用への切り替え
2. **構造的な問題**: セクション分割、ファイル分割
3. **内容の問題**: 曖昧な指示の具体化、重複の除去
4. **CLAUDE.md との関係**: 重複の除去、矛盾の解消

**修正後は必ず再レビュー**を実行して、問題が解決されたことを確認してください。

---

## [5/5] 完了サマリー

### サマリー表示

以下の情報を表示してください:

```
✓ ルールの作成が完了しました

ルール名: [ルール名].md
スコープ: [パス指定（対象パス）/ 常時適用]
妥当性判定: [N/5 該当]

作成されたファイル:
- .claude/rules/[ルール名].md

レビュー結果:
- [問題なし / N件の問題を自動修正]
```

---

## 重要な注意事項

### 妥当性判定は必須

- ステップ2のルール化妥当性判定は**スキップ不可**
- 0〜1個該当でユーザーが続行を希望する場合は、コンテキストコストのトレードオフを明示した上で作成する

### 既存ルールへの追記パス

- 2〜3個該当の場合は新規ファイルを作らず、既存ルールへの追記を優先する
- 追記先が明確でない場合のみ新規ファイルを作成する

### 自動修正の制限

- 最大3回まで自動修正を試行
- 3回試行しても問題が解決しない場合は、ユーザーに手動対応を依頼

### 依存スキル

- このスキルはステップ [4/5] で `review-rule` スキルを使用する。`review-rule` が未インストールの場合、レビュー・自動修正はスキップされる

### エラーハンドリング

- 同名のルールが既に存在する場合はユーザーに上書き確認
- review-rule の実行エラー時はリトライオプションを提供
