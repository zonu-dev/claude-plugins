---
name: review-slide
description: "Marp スライドを PNG 画像に変換し、全ページを目視チェックして、はみ出し・レイアウト崩れを検出・報告する。「スライドをレビューして」「レイアウトを確認して」「はみ出しをチェック」などのリクエストで使用する。"
allowed-tools: Bash(bash:*), Bash(npm run:*), Read, Edit, Glob, Grep
---

# スライドレビュー

Marp スライドを PNG に変換し、全ページの画像を Read ツールで読み取って、はみ出し・重なり・切れ・レイアウト崩れを検出して報告する。

> **依存**: このスキルは `create-slide` スキルの参照ファイルを symlink 経由で参照する。
> - `references/content-limits.md` → `create-slide/references/content-limits.md`
> - `references/mermaid-guide.md` → `create-slide/references/mermaid-guide.md`

## 引数

```
/review-slide                          # slides/ 配下の全 .md を対象
/review-slide quality-tools.md         # 特定ファイルのみ
```

## ワークフロー

### 1. 対象ファイルを特定する

- 引数でファイル名が指定されていればそれを使う（`slides/` プレフィックスは自動補完）
- 指定がなければ `slides/**/*.md` を再帰 Glob で列挙し、すべて対象にする
- 対象ファイルが存在しない場合はエラーを報告して終了する

### 2. PNG 画像を生成する

対象ファイルごとにラッパースクリプトで PNG を生成する。**リポジトリルートから**実行すること。

```bash
base="<basename>"
out_dir="/tmp/marp-review-${base}"

# scripts/ はリポジトリルートの scripts/ ディレクトリ
bash scripts/marp-export-png.sh "$out_dir" "slides/<ファイル名>"
```

スクリプト内部で以下を処理する（直接呼び出し不要）:
- `mkdir -p` による出力先の作成
- `< /dev/null` による stdin ハング防止
- `--` によるファイル引数の分離
- 拡張子なし連番 → `.png` へのコピー

Marp CLI オプションの設計意図:
- `--no-config-file`: `.marprc.yml` の `inputDir` との競合を避ける
- `--allow-local-files`: SVG 画像の参照を解決する
- `--theme-set ./slides/themes/`: カスタムテーマを認識させる。**`.marprc.yml` の `themeSet` と同じディレクトリパスを指定すること**（CSS ファイル直接指定ではブラウザプレビューと結果が異なる）
- `--image-scale 1`: 1280×720 で PNG を生成する

#### エラー時の対処

Marp CLI が失敗した場合は以下を確認し、エラーメッセージをユーザーに報告して終了する。

| エラー | 対処 |
|--------|------|
| テーマ未検出 | `--theme-set` のパスが正しいか確認 |
| npx 実行失敗 | リポジトリルートで `npm install` を実行して依存を復元 |
| 出力先書き込み失敗 | `/tmp/` の空き容量を確認 |
| PNG が 0 枚 | Markdown のフロントマター（`marp: true`）を確認 |

### 3. ソースコードでコンテンツ量を事前チェックする

**PNG エクスポートはスライド境界でコンテンツをクリップするため、はみ出しが画像上では見えない。** 画像チェックの前に Markdown ソースを分析する。

対象ファイルごとに以下を実行し、警告を取得して判定に含める:

```bash
npm run marp:lint -- --warn-only "slides/<ファイル名>"
```

Markdown ソースを Read で読み取り、[references/source-check-rules.md](references/source-check-rules.md) の全 6 ルールでチェックする:

1. **コンテンツ量**: 各スライドのコンテンツ量を [content-limits.md](references/content-limits.md) の判定上限と照合
2. **図テーマ切替**: SVG が `diagram-theme-switch` で 2 枚構成か
3. **Mermaid 可読性**: 横一列ノード数、テキスト左寄せ
4. **CJK 桁揃え**: 表示幅ベースの計算誤りを検出
5. **矢印方向**: 依存関係の矢印が依存元→依存先の向きか
6. **折り返し孤立文字**: 見出し・▶ 行の表示幅が判定上限を超えていないか

### 4. 全ページの画像を読み取ってチェックする

**Read ツールで各 PNG を 8 枚ずつ並列で読み取る。**

[references/review-checklist.md](references/review-checklist.md) の 17 観点でチェックする。

### 5. 結果を報告する

```
## レビュー結果: slides/quality-tools.md (33 ページ)

### 問題あり

| ページ | タイトル | 問題 |
|--------|---------|------|
| 11 | Jest とは | 最下行テキストがページ番号に重なっている |
| 17 | commitlint とは | テーブルが下端で切れている |
| 27 | knip ワークスペース | 箇条書き3行目が見切れている |

### 問題なし: 30 / 33 ページ
```

問題がなければ「全ページ問題なし」と報告する。

## コンテンツ量ガイドライン

レビュー時の判定上限は [content-limits.md](references/content-limits.md) の**判定上限**列を参照。

## はみ出し修正パターン

レビューではみ出しが見つかった場合、以下のパターンで修正を提案する。

### フットノートが重なる・過多の場合

フットノートを**スピーカーノートに移動したり、末尾に用語集スライドを追加してはいけない**。以下の方法で対処する:

| 方法 | 使いどころ |
|------|----------|
| **メインコンテンツ削減** | フットノート 1-3 件で重なりが発生。コード行数やテーブル行数を減らし、フットノート分のスペースを確保する |
| **インライン化** | フットノートを減らせる場合。括弧で本文に統合する（例: `Axios（JS/TS の HTTP クライアント）`）。残りのフットノートだけ `<div class="footnotes">` に残す |
| **スライド分割** | フットノートが 4 件以上、またはメインコンテンツを減らせない場合。コンテンツを 2 枚に分けてフットノートも分散する |

### 図中テキストが小さい・読みづらい場合

| 方法 | 使いどころ |
|------|----------|
| **ノードをグループ化** | 横一列 6 ノード以上。関連ステップをフェーズ単位で 1 ノードにまとめ、最大 5 ノードに収める |
| **ノード内テキストを左寄せ** | 番号付き項目が中寄せでガタガタ。`<div style='text-align:left'>` で囲む |
| **`--diagram-width` を拡大** | ノード数は適正だが文字が小さい。`800px` → `1050px` 等に拡大する |

詳細は [mermaid-guide.md](references/mermaid-guide.md) の「記法の注意点」を参照。

### 折り返し孤立文字（見出し・▶行）の場合

| 方法 | 使いどころ |
|------|----------|
| **表現を短縮** | 2 行目に 1〜4 文字残る場合。修飾語（「〜のための」「〜による」等）を削って 1 行に収める |
| **語順を調整** | 短縮が難しい場合。句読点や助詞の位置で自然な折り返しになるよう並べ替える |
| **主語＋動詞に圧縮** | 見出しが長すぎる場合。「5 つのレイヤー分離ルールが routes → services → repositories の一方向を強制する」→「5 つのレイヤー分離ルールが API の依存方向を強制する」 |

判定基準: [content-limits.md](references/content-limits.md) の「折り返し孤立文字の防止」を参照。

### コードブロック内の CJK 混合桁揃え計算誤りの場合

| 方法 | 使いどころ |
|------|----------|
| **表示幅ベースでスペース数を再計算する** | 計算誤り（CJK=2, ASCII=1 で計算していない等）が原因の場合。正しく計算し直すだけで大幅に改善する |
| **CJK 文字数差を考慮して微調整する** | 表示幅計算は正しいが行間の CJK 文字数差が大きい場合。CJK 文字数が少ない行のスペースを CJK 文字数差 8 文字あたり約 1 個減らす目安で調整する。完璧には揃わないが許容範囲に近づく |

許容範囲と検出限界の詳細は [references/source-check-rules.md](references/source-check-rules.md) の「CJK 混合桁揃えチェック」を参照。微細なズレの最終確認はブラウザプレビューでのみ可能。

### その他のはみ出し

| 原因 | 対処 |
|------|------|
| コードブロックが長い | 行数を減らすか、2 スライドに分割 |
| 箇条書きが多い | グループ化するか、2 スライドに分割 |
| テーブル行数超過 | 列を減らすか、2 スライドに分割 |

## 注意事項

- macOS/Linux 環境を前提とする。Windows 環境では WSL 上での使用を推奨する
- PNG 生成は必ずリポジトリルートから `bash scripts/marp-export-png.sh` 経由で実行する（シェルオペレーターをスクリプト内に閉じ込め、Claude Code のパーミッションプロンプトを回避するため）
- `--image-scale 1` でレビューする。`--image-scale` はレイアウトを変えず解像度のみ変える。scale 2 にしても Read ツールが内部で縮小するため検出精度は向上しない
- **PNG エクスポートはスライド境界でコンテンツをクリップする**。画像だけでは下部はみ出しを検出できないため、必ずステップ 3 のソースコード分析を併用する
- テーマ切替対象の SVG は `diagram-theme-switch` を必須にする。直接 `![](...svg)` は NG
- PNG は `/tmp/` に生成するため、セッション終了後に自動削除される
- `lead` クラスのスライド（タイトルページ）は空白が多くても問題なし
- スライドの内容の正確性・わかりやすさはこのスキルの対象外（レイアウトのみ）
