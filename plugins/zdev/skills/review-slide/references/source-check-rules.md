# ソースコード事前チェックルール

PNG エクスポートはスライド境界でコンテンツをクリップするため、はみ出しが画像上では見えない。画像チェックの前に Markdown ソースを分析し、以下の 6 ルールでチェックする。

## 1. コンテンツ量チェック

各スライド（`---` 区切り）のコンテンツ量を [content-limits.md](../../create-slide/references/content-limits.md) の**判定上限**と照合する。

特に以下のパターンは高確率ではみ出す:

| パターン | 例 |
|---------|---|
| コードブロック + フットノート | コード 10 行 + フットノート 2 件 |
| テーブル + フットノート | テーブル 6 行 + フットノート 2 件 |
| コードブロック + 箇条書き + フットノート | コード 7 行 + 箇条書き 2 + フットノート 3 件 |
| SVG 画像 + テキスト + フットノート | 画像 w:800 + テキスト + フットノート 1 件 |

### フットノート補正

`<div class="footnotes">` は `position: absolute` でスライド下部に固定されるため、メインコンテンツと**重なる**。[content-limits.md](../../create-slide/references/content-limits.md) の「フットノート使用時の補正」に従い、フットノート件数分の差し引きを適用して判定上限と照合する。4 件以上のフットノートは無条件で NG。

## 2. 図テーマ切替チェック

- SVG を Markdown 画像（`![](...)`）で直接埋め込んでいないか
- SVG は `diagram-theme-switch` で `diagram-default` と `diagram-midnight` の 2 枚構成か
- `diagram-midnight` が `-midnight.svg` を参照しているか
- 参照先ファイルが実在するか

## 3. Mermaid 図可読性チェック

- スライドから参照される `.mmd` ファイルを特定し、`flowchart LR` の横一列ノード数を数える
- **横一列 6 ノード以上はフェーズごとにグループ化が必要**として NG 判定する
- 番号付き項目や複数行テキストを含むノードで `text-align:left` が未指定の場合は NG 判定する

## 4. CJK 混合桁揃えチェック

- コードブロック内でスペースによる桁揃え（複数行で特定文字の開始位置を揃える意図）を検出する
  - 検出パターン: 複数行に同じ記号（`←`, `//`, `#` 等）が現れ、その前に異なる数のスペースがある
- 桁揃え行に **CJK 文字・emoji と ASCII 文字が混在**している場合、表示幅ベースでスペース数を計算して桁揃えを行う
  - CJK 文字・emoji（East Asian Width = W/F）は 2 幅、ASCII は 1 幅として各行のコンテンツ幅を算出する
  - 最長行のコンテンツ幅 + 3 を揃え位置とし、各行に必要なスペース数を決定する
  - **ただし CJK 文字数が行間で大きく異なる場合、フォントの文字幅差で微細なズレが残る**（CJK 文字数差 8 文字あたり約 1 スペース分のズレ）。この微細なズレは許容する
  - **この微細なズレは PNG 画像では検出できない**（Read ツールの解像度では視認不可能）。表示幅計算の明らかな誤り（1 スペース以上のズレ）のみソースコード分析で検出する
- 報告する場合: 「コードブロック内の桁揃えで表示幅計算の誤りを検出（行 N のスペースが M 個過不足）」

## 5. 矢印方向の整合性チェック

- 依存関係を示す Mermaid 図で `A --> B` は「A が B に依存する」を意味する。矢印が**依存元 → 依存先**の向きか確認する
  - NG: `core --> api_client`（基盤が上位に依存するように読める）
  - OK: `api_client --> core`（上位が基盤に依存）
- スライド本文中の `→` 表記を検索し、Mermaid 図と同じ依存方向を示しているか照合する
  - NG: 図は `mobile --> core` だが本文に `core → mobile の単方向設計` と書かれている
  - OK: 図もテキストも `mobile → core`（mobile が core に依存）で一致
- まとめスライドの箇条書きも忘れずに確認する（見落としやすい）

## 6. 折り返し孤立文字チェック

- 各スライドの `##` 見出しと `▶` 要点行の表示幅を計算する
  - CJK 文字・記号（全角）は 2 幅、ASCII（半角）は 1 幅として合算する
  - `## ` プレフィックスは表示されないため除外し、見出しテキスト本文のみ計測する
  - `▶` 文字自体は表示されるため幅に含める
- [content-limits.md](../../create-slide/references/content-limits.md) の「折り返し孤立文字の防止」の**判定上限**を超えていないか確認する
  - `## 見出し`: 半角 60 文字相当（全角 30 文字）
  - `▶ 要点` 行: 半角 80 文字相当（全角 40 文字）
- 超過している場合: 「見出し/▶ 行の表示幅が N 半角文字相当（判定上限: M）」と報告する
- `npm run marp:lint` でも作成時上限（見出し 56 / ▶ 行 76）で警告が出る
