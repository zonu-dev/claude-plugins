---
name: retro
description: "スキルの問題を振り返り、根本原因を分析して再発防止の改善を行う。「振り返りをして」「スキルの問題を分析して」「再発防止の改善をして」「retroして」などのリクエストで使用する。"
---

# retro

スキル・ルール・CLAUDE.md の問題を振り返り、根本原因を特定して再発防止の改善を実施する。

「何を直すべきか」はユーザーに最初から聞くのではなく、問題の理解を通じて一緒に見つけていく。

## 引数

```
/retro                    # 対話で問題を把握してから対象を特定
/retro <スキル名>         # スキル名をヒントに問題把握から開始
/retro <スキル名> <問題>  # スキル名と問題の両方をヒントに開始
```

**例**:

```
/retro
/retro create-slide
/retro create-slide コードブロックがはみ出す
```

引数はあくまで **ヒント** であり、問題の把握（Phase 1）を飛ばす理由にはならない。

---

## ワークフロー

全 5 フェーズで進行する。各フェーズの完了条件を満たしてから次に進むこと。

---

### Phase 1: 問題の把握

**目的**: 何が起きたのかを正確に理解する。改善対象（何を直すか）はまだ決めない。

#### 1-1. 情報源の確認

まず以下の順で問題の手がかりを集める:

1. **引数の確認** — `/retro create-slide` のようにスキル名が渡された場合、対象スキルのヒントとして記憶する（この時点では確定しない）
2. **会話コンテキストの確認** — 直前の会話に問題の痕跡（エラー、期待と異なる出力、ユーザーの不満）がないか探す
3. **推定可能なら確認** — AskUserQuestion で「この認識で合っていますか？」とユーザーに確認する。選択肢: 「合っている」「違う」

#### 1-2. 対話による深掘り

コンテキストから問題を推定できない場合、段階的な対話で深掘りする。

**ラウンド 1** — 状況の聞き取り:

AskUserQuestion で以下を尋ねる:

> 何がうまくいきませんでしたか？ どんな状況でしたか？

- 自由記述で回答してもらう
- 回答が短い場合は「もう少し具体的に教えてください」と追加質問する

**ラウンド 2** — 関連箇所の推定:

- ユーザーの回答から関連しそうなスキル・ルール・設定ファイルを推定する
- 推定した対象を Read で読み込み、関連箇所を特定する
- 「この部分が関係していそうですが、合っていますか？」と確認する

**ラウンド 3（必要な場合のみ）** — 追加確認:

- ラウンド 2 で問題の全体像がつかめない場合のみ実施
- 具体的な再現手順や発生条件を確認する

#### 1-3. ユーザー自身もよくわからない場合

問題を言語化しにくい場合は、[references/root-cause-categories.md](references/root-cause-categories.md) の 8 カテゴリを要約して提示する:

> 以下のどれかに心当たりはありますか？
>
> 1. ルールが書かれていなかった（ルール欠如）
> 2. ルールはあるが曖昧だった（ルール曖昧）
> 3. 間違いに気づく仕組みがなかった（バリデーション不足）
> 4. デフォルト値が実態に合っていなかった（デフォルト不適切）
> 5. 良い例・悪い例がなくて判断できなかった（例示不足）
> 6. 特定の条件で想定外の動作をした（スコープ不足）
> 7. チェックのタイミングが遅すぎた（ワークフロー順序）
> 8. 参照ファイルの内容が矛盾していた（参照ファイル不整合）

ユーザーが選んだカテゴリを起点に問題を具体化する。

#### 1-4. Phase 1 の完了条件

以下を全て満たすこと:

- [ ] 何が起きたか（症状）を 1〜2 文で説明できる
- [ ] ユーザーが「その認識で合っている」と確認済み
- [ ] 対話ラウンドは最大 3 回まで（3 回で収束しない場合は現時点の理解で次に進む）

---

### Phase 2: 改善対象の特定と分析

**目的**: Phase 1 で理解した問題に基づき、**何を直すべきか** を特定する。

#### 2-1. 改善対象の候補提示

Phase 1 の問題理解をもとに、改善対象の候補を提示する:

```
改善対象の候補:
  1. .claude/skills/create-slide/SKILL.md — ステップ 9 のレビューループ条件
  2. .claude/skills/create-slide/references/content-limits.md — コードブロックの上限定義
```

AskUserQuestion で確認:

> この対象で合っていますか？ 他に直すべき箇所はありますか？

選択肢:
- この対象で進める (推奨)
- 他にも直すべき箇所がある
- 対象が違う

#### 2-2. 対象ファイルの読み込み

確定した改善対象について:

1. 対象ファイル本体を Read で全文読み込む
2. 対象ファイルと同じディレクトリの `references/` 配下を Glob で列挙
3. `references/` 配下のファイルを全て Read で読み込む
4. 問題が発生した箇所とファイルの対応関係を整理する

#### 2-3. Phase 2 の完了条件

- [ ] 改善対象ファイルのパスが確定している
- [ ] 対象ファイル + references/ を全て読み込み済み
- [ ] 問題箇所と対象ファイルの対応関係を把握している

---

### Phase 3: 根本原因の分析と改善提案

**目的**: なぜ問題が起きたのかを特定し、具体的な改善案を提示する。

#### 3-1. 根本原因の特定

[references/root-cause-categories.md](references/root-cause-categories.md) の 8 カテゴリに照らして根本原因を分類する。

複数のカテゴリに該当する場合は全て列挙する。

#### 3-2. 分析結果の提示

以下のフォーマットで分析結果を提示する:

```markdown
## 振り返り分析

### 問題
<Phase 1 で把握した問題の要約>

### 根本原因
| # | カテゴリ | 説明 | 該当箇所 |
|---|---------|------|---------|
| 1 | ルール曖昧 | コードブロックの行数上限が「適切に」としか書かれていない | content-limits.md L42 |
| 2 | バリデーション不足 | はみ出しチェックがコードブロックを対象外にしている | SKILL.md L185 |

### 改善提案
| # | 対象ファイル | 変更内容 | 根本原因 # |
|---|------------|---------|-----------|
| 1 | content-limits.md | コードブロック行数上限を 12 行に明記 | 1 |
| 2 | SKILL.md | レビューループでコードブロックはみ出しもチェック | 2 |
```

#### 3-3. ユーザー承認

AskUserQuestion で確認:

> この分析と改善提案について、どう進めますか？

選択肢:
- 全て実施する (推奨)
- 選択して実施する
- 修正が必要

「選択して実施する」の場合:
- AskUserQuestion（multiSelect: true）で実施する改善を選択してもらう

「修正が必要」の場合:
- 修正内容を聞き取り、改善提案を更新して再度確認する（最大 2 回）

#### 3-4. Phase 3 の完了条件

- [ ] 根本原因を 8 カテゴリのいずれかに分類済み
- [ ] 改善提案をテーブル形式で提示済み
- [ ] ユーザーが実施内容を承認済み

---

### Phase 4: 改善の実施

**目的**: 承認された改善を対象ファイルに反映する。

#### 4-1. 実施ルール

- Edit ツールで既存ファイルを編集する（新規ファイルの作成は最小限に）
- 変更は承認された内容のみ。スコープ外の「ついでの改善」は行わない
- 各変更ごとにどの改善提案 # に対応するかをコメントで明記する

#### 4-2. 行数制約

SKILL.md の行数は **500 行以下** を維持する。

超過する場合の対処:
1. 追加内容を `references/` 配下の新規ファイルに分離する
2. SKILL.md からは参照リンクで誘導する
3. ファイル名は kebab-case（例: `edge-case-patterns.md`）

#### 4-3. 変更サマリー

実施した変更を一覧で出力する:

```
実施した変更:
  1. ✅ content-limits.md L42 — コードブロック行数上限を 12 行に明記（提案 #1）
  2. ✅ SKILL.md L185 — レビューループにコードブロックチェックを追加（提案 #2）
```

#### 4-4. Phase 4 の完了条件

- [ ] 承認された全ての改善を実施済み
- [ ] SKILL.md が 500 行以下
- [ ] 変更サマリーを出力済み

---

### Phase 5: レビューで検証

**目的**: 改善が正しく反映されたことを検証する。

#### 5-1. 検証方法の選択

改善対象の種別に応じて検証方法を選択する:

| 改善対象の種別 | 検証方法 |
|--------------|---------|
| スライド作成スキル (`create-slide`) | Skill ツールで `/review-slide` を呼び出し |
| スライドレビュースキル (`review-slide`) | references/ のリンク整合性を手動確認 |
| その他のスキル | references/ のリンク整合性を手動確認 |
| CLAUDE.md / ルール | 変更箇所を Read で再読み込みして確認 |

#### 5-2. リンク整合性チェック

全ての改善対象について以下を確認する:

1. SKILL.md 内の `references/` リンクが全て有効か（Glob で存在確認）
2. references/ ファイル内の相互参照リンクが全て有効か
3. 他スキルへの参照パス（`../create-slide/references/` 等）が正しいか

リンク切れを発見した場合は自動修正する。

#### 5-3. レビュースキル呼び出し（該当する場合）

review 系スキルが存在する対象の場合:

1. Skill ツールで該当の review スキルを呼び出す
2. 問題が検出された場合は自動修正する
3. 再度 review スキルを呼び出す
4. **最大 3 回** のループで収束させる
5. 3 回で収束しない場合は残存問題をユーザーに報告する

#### 5-4. 完了サマリー

最終結果を以下のフォーマットで出力する:

```markdown
## retro 完了サマリー

### 問題
<問題の要約（1〜2 文）>

### 根本原因
<カテゴリ名と説明>

### 実施した改善
| # | 対象ファイル | 変更内容 |
|---|------------|---------|
| 1 | ... | ... |

### 検証結果
- リンク整合性: ✅ OK
- レビュースキル: ✅ 問題なし（または ⚠️ 残存問題あり）

### 再発防止のポイント
<今後同じ問題を起こさないための 1〜2 行のアドバイス>
```

#### 5-5. Phase 5 の完了条件

- [ ] リンク整合性チェック完了
- [ ] 該当する review スキルの呼び出し完了（または非該当）
- [ ] 完了サマリーを出力済み

---

## 注意事項

### 対話の原則

- Phase 1 の問題把握を省略しない。引数にスキル名があっても「何が問題か」の確認は必須
- ユーザーの言葉をそのまま使う。専門用語に言い換えない
- 「他にありますか？」と聞きすぎない。3 ラウンド以内で収束させる

### 変更のスコープ

- 承認された改善のみ実施する。「ついでに」の改善は行わない
- 1 回の retro で扱う問題は 1 つに絞る。複数の問題がある場合は最も重要なものから
- 他のスキルのファイルを変更する場合は、そのスキルの構造を事前に理解してから行う

### ファイル操作

- 既存ファイルの編集には Edit ツールを使う（Write での全体上書きは避ける）
- 新規ファイル作成時は kebab-case で命名する
- references/ 配下のファイルは SKILL.md から参照リンクを張ること

### エラー時の対処

- Read でファイルが見つからない場合: Glob でパスを探索してからリトライ
- Edit で old_string が見つからない場合: Read で最新の内容を確認してからリトライ
- review スキルが存在しない場合: リンク整合性チェックのみで検証を完了する
